# Razorpay Payment API Documentation

This documentation outlines the updated, integrated endpoints for handling payments with Razorpay.

## 1. Create Razorpay Order from Payment Request

This endpoint initiates a payment by creating a Razorpay order based on an existing payment request in the system. It fetches the payment details, including the total amount, using the `requestId`.

- **URL**: `/api/payment-requests/create-order`
- **Method**: `POST`
- **Authentication**: Required (Society Member)
- **Headers**:
  - `Authorization`: `Bearer <your_jwt_token>`

### Request Body

| Field       | Type   | Required | Description                                                    |
| :---------- | :----- | :------- | :------------------------------------------------------------- |
| `requestId` | String | Yes      | The unique `_id` or `requestId` of the payment request to be paid. |

### Example Request

```bash
curl -X POST \
  http://localhost:3000/api/payment-requests/create-order \
  -H 'Authorization: Bearer <your_jwt_token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "requestId": "6054c2a5b6c2b12f4c8d4a5e"
}'
```

### Success Response (`200 OK`)

Returns the Razorpay order object and the internal `requestId` (`_id`) to be used for verification.

```json
{
    "success": true,
    "order": {
        "id": "order_XXXXXXXXXXXXXX",
        "entity": "order",
        "amount": 50000,
        "amount_paid": 0,
        "amount_due": 50000,
        "currency": "INR",
        "receipt": "PR202403123456",
        "status": "created"
    },
    "requestId": "6054c2a5b6c2b12f4c8d4a5e"
}
```

---

## 2. Verify Razorpay Payment

This endpoint verifies the authenticity of a payment after the user completes the transaction. It securely validates the payment signature and updates the corresponding payment request's status to `PAID`.

- **URL**: `/api/payment-requests/verify-payment`
- **Method**: `POST`
- **Authentication**: None (Verification is done via signature)

### Request Body

| Field           | Type   | Required | Description                                                    |
| :-------------- | :----- | :------- | :------------------------------------------------------------- |
| `order_id`      | String | Yes      | The `order_id` received from the "Create Order" endpoint.      |
| `payment_id`    | String | Yes      | The `payment_id` generated by Razorpay after a successful payment. |
| `signature`     | String | Yes      | The HMAC SHA256 signature returned by Razorpay for verification. |
| `requestId`     | String | Yes      | The MongoDB `_id` of the payment request, returned from the create order step. |

### Example Request

```bash
curl -X POST \
  http://localhost:3000/api/payment-requests/verify-payment \
  -H 'Content-Type: application/json' \
  -d '{
    "order_id": "order_XXXXXXXXXXXXXX",
    "payment_id": "pay_YYYYYYYYYYYYYY",
    "signature": "your_razorpay_signature",
    "requestId": "6054c2a5b6c2b12f4c8d4a5e"
}'
```

### Success Response (`200 OK`)

Returns a success message and the updated payment summary.

```json
{
    "success": true,
    "message": "Payment verified successfully",
    "data": {
        "requestId": "PR202403123456",
        "paymentType": "RD",
        "amount": 500,
        "totalAmount": 500,
        "dueDate": "2024-04-12T00:00:00.000Z",
        "status": "PAID",
        "paymentMethod": "UPI",
        "description": "Monthly RD Installment"
    }
}
```
